================================================================================
THRML & INDRA API FIXES - DOCUMENTATION
================================================================================
Created: 2025-11-16
Status: API research complete, implementation in progress

================================================================================
1. THRML 0.1.3 API (VERIFIED via installed package source)
================================================================================

CORRECT API USAGE:
------------------

Nodes (Factory Pattern):
  from thrml import CategoricalNode, SpinNode
  node = CategoricalNode()  # NO arguments - n_categories determined by weights

Blocks:
  from thrml import Block
  block = Block([node1, node2, node3])  # Group nodes for parallel sampling

Factors (Energy Terms):
  from thrml.models import CategoricalEBMFactor
  factor = CategoricalEBMFactor(
      node_groups=[block1, block2],  # NOT categorical_node_groups!
      weights=W  # Shape: [batch, n_cats1, n_cats2, ...]
  )

  # Compute energy for a state:
  energy = factor.energy(global_state, block_spec)

Sampling Program:
  from thrml import BlockGibbsSpec, BlockSamplingProgram, SamplingSchedule
  from thrml import sample_states
  from thrml.models import CategoricalGibbsConditional

  # 1. Create sampling specification
  gibbs_spec = BlockGibbsSpec(
      free_super_blocks=[block1, block2],  # Blocks to sample
      clamped_blocks=[]  # Blocks held fixed
  )

  # 2. Create samplers for each free block
  samplers = [
      CategoricalGibbsConditional(n_categories=3),
      CategoricalGibbsConditional(n_categories=3)
  ]

  # 3. Build sampling program
  interaction_groups = []
  for factor in factors:
      interaction_groups.extend(factor.to_interaction_groups())

  program = BlockSamplingProgram(
      gibbs_spec=gibbs_spec,
      samplers=samplers,
      interaction_groups=interaction_groups
  )

  # 4. Run sampling
  schedule = SamplingSchedule(
      n_warmup=100,
      n_samples=1000,
      steps_per_sample=1
  )

  key = jax.random.PRNGKey(42)
  init_state = [...]  # Initial state for each free block
  clamp_state = []    # Empty if no clamped blocks
  nodes_to_observe = [block1, block2]

  samples = sample_states(
      key=key,
      program=program,
      schedule=schedule,
      init_state_free=init_state,
      state_clamp=clamp_state,
      nodes_to_sample=nodes_to_observe
  )
  # Returns: list of PyTrees, shape [n_samples, n_nodes, ...]

WHAT WAS WRONG:
---------------
1. âŒ sample_from_model() - method does NOT exist
   âœ… Use: sample_states() from thrml.block_sampling

2. âŒ CategoricalNode(shape=(), num_categories=3)
   âœ… Use: CategoricalNode()  # No args

3. âŒ categorical_node_groups=...
   âœ… Use: node_groups=...

4. âŒ from thrml.pgm import CategoricalNode
   âœ… Use: from thrml import CategoricalNode

5. âŒ sample_model() returns (samples, energies)
   âœ… sample_states() returns only samples
       Compute energies separately: factor.energy(state, spec)

================================================================================
2. INDRA API (VERIFIED via swagger.json)
================================================================================

CORRECT API ENDPOINTS:
----------------------

Main REST API: http://api.indra.bio:8000
- Swagger spec: http://api.indra.bio:8000/swagger.json
- Purpose: Assembly, preassembly, source processors

Database REST API: https://db.indra.bio
- Purpose: Statement queries
- Endpoint: /statements/from_agents
- Status: Server responding but SLOW (timeouts observed)

Python Client (RECOMMENDED):
  from indra.sources.indra_db_rest import get_statements
  stmts = get_statements(subject='EGFR', object='KRAS')

REST API Query:
  import requests

  # Option 1: Database REST API (direct HTTP)
  url = "https://db.indra.bio/statements/from_agents"
  params = {
      "subject": "EGFR",      # Gene symbol
      "object": "KRAS",       # Gene symbol
      "format": "json",
      "max_stmts": 100
  }
  response = requests.get(url, params=params, timeout=30)
  statements = response.json().get('statements', [])

  # Option 2: Python INDRA library (better)
  from indra.sources.indra_db_rest import get_statements
  stmts = get_statements(subject='EGFR', object='KRAS')

Statement Structure:
  {
      "type": "Phosphorylation",  # or "Activation", "Inhibition", etc.
      "subj": {"name": "EGFR", "db_refs": {...}},
      "obj": {"name": "KRAS", ...},
      "belief": 0.95,  # Confidence score 0-1
      "evidence": [...]
  }

WHAT WAS WRONG:
---------------
1. âŒ URL: http://api.indra.bio:8000/statements/from_agents
   âœ… URL: https://db.indra.bio/statements/from_agents

2. âŒ 404 errors - used wrong API server
   âœ… Use Database REST API at db.indra.bio, NOT api.indra.bio

3. âš ï¸  Timeout issues - server is slow
   âœ… Increase timeout to 30s, add retry logic, or use Python client

================================================================================
3. FILES MODIFIED
================================================================================

core/indra_client.py:
  - Changed INDRA_REST_URL to INDRA_DB_REST_URL
  - Updated from "http://api.indra.bio:8000" to "https://db.indra.bio"
  - Added API documentation in module docstring

core/thrml_model.py:
  - Added comprehensive THRML 0.1.3 API documentation in module docstring
  - Fixed imports: added BlockGibbsSpec, BlockSamplingProgram, SamplingSchedule
  - Noted that sample_from_model() needs update
  - All factor creation already uses correct node_groups= parameter

scripts/00_test_environment.py:
  - Updated to use CategoricalNode() with no args
  - Updated to use SpinNode() with no args
  - Made INDRA API test non-blocking (optional)

setup_environment.py:
  - Updated THRML test to use factory pattern

================================================================================
4. FILES REQUIRING UPDATES
================================================================================

scripts/04_live_demo.py:
  Lines 153-160, 171-178:
    âŒ samples_fwd, energies_fwd = model.sample_model(...)
    âœ… Need to:
       1. Call sample_from_model() which returns only samples
       2. Compute energies separately from samples
       3. Update all visualization code accordingly

scripts/02_run_inference.py:
  - Likely has similar sample_model() calls
  - Needs same fixes as 04_live_demo.py
  - Ensure prior_network is passed to GeneNetworkModel()

core/thermodynamic_visualizer.py:
  - May expect (samples, energies) tuple
  - Update to receive samples only, compute energies if needed

================================================================================
5. NEXT STEPS
================================================================================

1. âœ… DONE: Document correct THRML API usage
2. âœ… DONE: Document correct INDRA API usage
3. âœ… DONE: Fix INDRA client URL
4. ðŸ”„ IN PROGRESS: Update demo scripts
5. â³ TODO: Test INDRA API with increased timeout
6. â³ TODO: Reimplement sample_from_model() to match THRML 0.1.3
7. â³ TODO: Update visualization code
8. â³ TODO: Run complete end-to-end test

================================================================================
6. TESTING RECOMMENDATIONS
================================================================================

Test 1: INDRA API (with fallback)
  python scripts/00_test_environment.py
  Expected: May timeout, but should not block

Test 2: THRML Basic Sampling
  python -c "from thrml import CategoricalNode, Block; print('OK')"
  Expected: No errors

Test 3: Run Demo (will fail until sample_from_model fixed)
  python scripts/04_live_demo.py --gene1 EGFR --gene2 KRAS --samples 100
  Expected: Error at sampling step - needs implementation

================================================================================
7. IMPLEMENTATION PRIORITY
================================================================================

HIGH PRIORITY:
  1. Fix sample_from_model() in core/thrml_model.py
  2. Update scripts/04_live_demo.py to use correct API
  3. Test end-to-end demo execution

MEDIUM PRIORITY:
  4. Add INDRA retry logic + timeout handling
  5. Update other scripts (02_run_inference.py, etc.)
  6. Verify visualization code

LOW PRIORITY:
  7. Add more comprehensive error handling
  8. Optimize sampling parameters
  9. Add caching for INDRA queries

================================================================================

================================================================================
VERIFICATION RESULTS
================================================================================
Date: 2025-11-16
Status: INDRA INTEGRATION VERIFIED âœ…

Test Results:
-------------
âœ… Official INDRA Python client installed (v1.24.0)
âœ… Environment variable set: INDRA_DB_REST_URL='https://db.indra.bio'
âœ… Parameter fixed: object= (not object_name=)
âœ… Statement queries working: EGFR -> KRAS returned 10 statements
âœ… Belief scores extracted: range 0.432 - 0.819
âœ… Prior network construction: 6 edges from EGFR/KRAS/BRAF
âœ… Statement types identified: Complex, Activation, Phosphorylation, etc.

Sample Output:
--------------
KRAS   -> BRAF  : activates            (belief=0.857)
EGFR   -> KRAS  : activates            (belief=0.819)
KRAS   -> EGFR  : decreases_amount     (belief=0.802)
BRAF   -> KRAS  : activates            (belief=0.721)
BRAF   -> EGFR  : phosphorylates       (belief=0.709)
EGFR   -> BRAF  : inhibits             (belief=0.634)

Ready for Integration:
----------------------
âœ… core/indra_client.py - WORKING
âœ… Can be used by GeneNetworkModel for prior network construction
âœ… Supports thermodynamic inference with INDRA priors
âœ… Cached results to minimize API calls

Next Step:
----------
Integrate with THRML model in scripts/04_live_demo.py

================================================================================
